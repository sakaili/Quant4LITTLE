# 币安测试网Maker订单测试指南

## 📋 脚本说明

[scripts/test_testnet_maker.py](scripts/test_testnet_maker.py) - 币安测试网真实下单测试脚本

### 功能特点

1. ✅ **支持测试网和主网** - 通过环境变量切换
2. ✅ **完整做空流程** - 入场、持仓、出场
3. ✅ **Maker限价单** - 0.10%偏移，获得返佣
4. ✅ **智能超时处理** - 60秒超时自动取消或市价平仓
5. ✅ **详细统计** - 实时显示盈亏、费用、成交信息
6. ✅ **安全机制** - 紧急市价平仓功能

---

## 🚀 使用方法

### 步骤1: 设置环境变量

在PowerShell中执行：

```powershell
# 设置API密钥
$env:BINANCE_API_KEY = "你的API密钥"
$env:BINANCE_API_SECRET = "你的API密钥"

# 选择测试网或主网
$env:USE_TESTNET = "True"   # True=测试网, False=主网

# 代理设置（如果需要）
$env:HTTPS_PROXY = "http://127.0.0.1:7890"
```

### 步骤2: 运行测试脚本

```powershell
cd F:\2025\Quant4Little
python scripts\test_testnet_maker.py
```

### 步骤3: 观察测试流程

脚本会按以下顺序执行：

1. **连接测试** - 验证API连接和余额
2. **确认提示** - 显示交易参数，等待确认
3. **做空入场** - 下Maker限价卖单
4. **等待成交** - 最多等待60秒
5. **模拟持仓** - 持仓10秒，实时显示浮动盈亏
6. **做空出场** - 下Maker限价买单平仓
7. **结果汇总** - 显示最终盈亏和费用

---

## 📊 测试参数

### 默认配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 交易对 | BTC/USDT:USDT | 流动性最好 |
| 数量 | 0.001 BTC | 约80-100 USDT |
| Maker偏移 | 0.10% | 离盘口距离 |
| 超时时间 | 60秒 | 订单等待时间 |
| 持仓时间 | 10秒 | 模拟持仓（真实场景是5天） |

### 修改参数

编辑 [scripts/test_testnet_maker.py](scripts/test_testnet_maker.py) 第 387-389 行：

```python
# 修改交易对
symbol = 'ETH/USDT:USDT'  # 改为ETH

# 修改数量
amount = 0.01  # 0.01 ETH

# 修改Maker偏移
executor = BinanceTestnetMaker(
    maker_offset_pct=0.15,  # 改为0.15%
    max_wait_seconds=120    # 改为120秒
)
```

---

## ⚙️ 测试网 vs 主网

### 测试网模式 (推荐) ✅

**特点**：
- 虚拟资金，零风险
- 完全真实的交易环境
- 适合学习和调试

**设置**：
```powershell
$env:USE_TESTNET = "True"
```

**API密钥申请**：
- 期货测试网：https://testnet.binancefuture.com
- 现货测试网：https://testnet.binance.vision

### 主网模式 (谨慎) ⚠️

**特点**：
- 真实资金
- 可能产生盈亏
- 需要谨慎操作

**设置**：
```powershell
$env:USE_TESTNET = "False"
```

---

## 📝 测试输出示例

### 成功的测试输出

```
██████████████████████████████████████████████████████████████████████
  🧪 币安测试网 - Maker订单做空交易测试
  测试时间: 2025-11-24 12:30:00
██████████████████████████████████████████████████████████████████████

======================================================================
  🌐 币安测试网Maker执行器
======================================================================
  模式: 🧪 测试网 (虚拟资金)
  Maker偏移: 0.1%
  最长等待: 60秒
  代理: http://127.0.0.1:7890
======================================================================

  🔌 测试API连接...
  ✅ 连接成功!
  💰 USDT余额: 10000.00

======================================================================
  📊 交易参数
======================================================================
  交易对: BTC/USDT:USDT
  数量: 0.001 BTC
  策略: 做空 (SHORT)
  订单类型: Maker限价单
======================================================================

======================================================================
  🔽 步骤1/3: 做空入场
======================================================================

──────────────────────────────────────────────────────────────────────
  📝 下做空入场限价单
──────────────────────────────────────────────────────────────────────
  交易对: BTC/USDT:USDT
  方向: SELL
  限价: 87544.50
  数量: 0.001
  盘口: Bid=87456.01, Ask=87500.00
  价差: 0.0502%
  ✅ 订单已下达! ID: 12345678

  ⏳ 等待订单成交 (最多60秒)...
  ✅ 完全成交!
    成交价: $87,544.50
    成交量: 0.0010
    耗时: 23秒

  ✅ 做空入场成功! 价格: $87,544.50

======================================================================
  ⏰ 步骤2/3: 模拟持仓
======================================================================
  在真实场景中，会持仓5天
  现在模拟持仓10秒...
  ⏱️  持仓中... 10/10秒 | 当前价: $87,200.00 | 浮动盈亏: +0.39% (+344.50 USDT)

======================================================================
  🔼 步骤3/3: 做空出场
======================================================================

──────────────────────────────────────────────────────────────────────
  📝 下做空出场限价单
──────────────────────────────────────────────────────────────────────
  交易对: BTC/USDT:USDT
  方向: BUY
  限价: 87112.80
  数量: 0.001
  盘口: Bid=87200.00, Ask=87250.00
  价差: 0.0574%
  ✅ 订单已下达! ID: 12345679

  ⏳ 等待订单成交 (最多60秒)...
  ✅ 完全成交!
    成交价: $87,112.80
    成交量: 0.0010
    耗时: 31秒

  ✅ 做空出场成功! 价格: $87,112.80

======================================================================
  💰 交易结果
======================================================================
  入场价: $87,544.50
  出场价: $87,112.80
  价格变动: -0.49%
  ─────────────────────────────────────
  做空毛收益: +0.49% ($+431.70)
  交易费用: -$0.0350
  净收益: +0.49% ($+431.67)
======================================================================

  🎉 交易盈利 $431.67 USDT!

======================================================================
  ✅ 测试完成!
======================================================================
```

---

## ⚠️ 常见问题

### Q1: 连接失败 "Invalid API-key"

**原因**：
- API密钥不正确
- 使用了主网密钥连接测试网
- 使用了测试网密钥连接主网

**解决**：
- 检查 `$env:USE_TESTNET` 设置
- 确认API密钥来源（测试网 or 主网）

### Q2: 订单超时未成交

**原因**：
- Maker订单价格不够吸引
- 市场流动性不足
- maker_offset_pct 设置太大

**解决**：
- 减小 `maker_offset_pct`（从0.10%改为0.05%）
- 增加等待时间
- 使用流动性更好的币种（BTC/ETH）

### Q3: 余额不足

**测试网**：
- 访问测试网网站领取虚拟资金
- 通常每天可以领取

**主网**：
- 确保账户有足够USDT
- 测试建议至少100 USDT

### Q4: 代理连接问题

**检查代理**：
```powershell
echo $env:HTTPS_PROXY
```

**测试代理**：
```powershell
curl -x http://127.0.0.1:7890 https://api.binance.com/api/v3/ping
```

---

## 🎯 下一步

### 测试成功后

1. **调整参数** - 测试不同的maker_offset_pct
2. **测试不同币种** - ETH、DOGE等
3. **记录统计** - 收集成交率、盈亏数据
4. **集成策略** - 将Maker逻辑集成到Paper Trading系统

### 进阶测试

创建批量测试脚本，测试你的Paper Trading信号：

```python
# 读取Paper Trading信号
signals = pd.read_csv('data/paper_trading/signals_20251124.csv')

# 对每个信号执行Maker下单
for signal in signals:
    executor.place_maker_order(...)
```

---

## 📖 相关文档

- [MAKER_ORDER_STRATEGY.md](MAKER_ORDER_STRATEGY.md) - Maker订单策略详解
- [scripts/maker_order_utils.py](scripts/maker_order_utils.py) - Maker订单工具库
- [scripts/test_maker_orders.py](scripts/test_maker_orders.py) - 模拟盘测试（无需API）

---

## 🔒 安全提示

1. ✅ **测试网优先** - 先在测试网充分测试
2. ✅ **小资金测试** - 主网测试用小额资金
3. ✅ **保管密钥** - 不要泄露API密钥
4. ✅ **限制权限** - API只开启期货交易权限
5. ✅ **监控持仓** - 随时检查持仓状态

---

祝测试顺利！🚀
